<html>
    <head>
        <title>absurd date parser</title>
        <script>
            function getDateString(date) {
                return date.toISOString().split('T')[0]
            }

            function padYear(year) {
                let tmp = Math.trunc(Math.abs(year)).toString()
                if (year < 0) {
                    while (tmp.length < 6) {
                        tmp = "0"+tmp
                    }
                    return "-" + tmp
                } else if (year > 9999) {
                    while (tmp.length < 6) {
                        tmp = "0" + tmp
                    }
                    return "+" + tmp
                } else { // 0000-9999
                    while (tmp.length < 4) {
                        tmp = "0" + tmp
                    }
                    return tmp
                }
            }

            function padDigits(num) {
                let tmp = Math.round(num).toString()
                if (tmp.length < 2) {
                    tmp = "0" + tmp
                }
                return tmp
            }

            function shouldPreserveYear(yearStr) {
                yearStr = yearStr.split('.')[0]
                return (yearStr.startsWith('-') && yearStr.length >= 5) || (!yearStr.startsWith('-') && yearStr.length >= 4)
            }

            function dateToDigits() {
                let formInfo = new FormData(document.getElementById('input-form'))
                let dat = formInfo.get('date').split("/")

                let data = {}
                let format = formInfo.get('format')
                if (format == "DD/MM/YY[YY]") {
                    data['d'] = parseFloat(dat[0])
                    data['m'] = parseFloat(dat[1])
                    data['y'] = dat[2]
                } else if (format == "MM/DD/YY[YY]") {
                    data['m'] = parseFloat(dat[0])
                    data['d'] = parseFloat(dat[1])
                    data['y'] = dat[2]
                } else if (format == "YY[YY]/MM/DD") {
                    data['y'] = dat[0]
                    data['m'] = parseFloat(dat[1])
                    data['d'] = parseFloat(dat[2])
                } else if (format == "YY[YY]/DD/MM") {
                    data['y'] = dat[0]
                    data['d'] = parseFloat(dat[1])
                    data['m'] = parseFloat(dat[2])
                }

                let preserve = shouldPreserveYear(data['y'])
                data['y'] = parseFloat(data['y'])
                if (!preserve) {
                    data['y'] += 2000
                }

                data['m'] -= 1 // javascript has months 0 indexed

                return data
            }

            function parseDate(event) {
                event.preventDefault()

                let date = dateToDigits()

                let usedYear = date['y']
                let modifiedYear = false
                if (Math.abs(usedYear) < 100) {
                    // some evil compression will happen and i need to be eviler to fix it
                    // this is only triggered if a year less than 100 from 0 is entered with leading zeroes to not convert to 2000s
                    // e.g. 1/1/0000

                    usedYear = Math.floor(usedYear) + 2000 // this should handle leap years maybe? polarity should work idk
                    modifiedYear = true
                }

                let startDate = new Date(Date.UTC(usedYear, date['m'], date['d'] + (date['y'] % 1) * (365.25)))

                let dayOffset = 0
                dayOffset += (date['m'] % 1) * (new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth()+1, 0))).getUTCDate()
                dayOffset += date['d'] % 1

                let finalDate = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate() + Math.round(dayOffset)))
                if (modifiedYear) { // it's time to strike
                    finalDate = new Date(`${padYear(finalDate.getUTCFullYear() - usedYear + date['y'])}-${padDigits(finalDate.getUTCMonth() + 1)}-${padDigits(finalDate.getUTCDate())}T01:01:01`)
                }

                document.getElementById('real-date').innerText = getDateString(finalDate)
            }

            function setPlaceholder() {
                let data = new FormData(document.getElementById('input-form'))

                document.getElementById('date-input').placeholder = data.get('format')
            }
        </script>
    </head>
    <body>
        <p>parses absurd dates (such as 25.25/25.25/25.25) into technically equivalent real ones</p>
        <p>this was so much simpler than expected since javascript basically just does what i wanted by default</p>
        <form id="input-form">
            <input type="radio" id="d/m/y" name="format" value="DD/MM/YY[YY]" checked onchange="setPlaceholder()">
            <label for="d/m/y">DD/MM/YY[YY]</label>
            <input type="radio" id="m/d/y" name="format" value="MM/DD/YY[YY]" onchange="setPlaceholder()">
            <label for="m/d/y">MM/DD/YY[YY]</label>
            <input type="radio" id="y/m/d" name="format" value="YY[YY]/MM/DD" onchange="setPlaceholder()">
            <label for="y/m/d">YY[YY]/MM/DD</label>
            <input type="radio" id="y/d/m" name="format" value="YY[YY]/DD/MM" onchange="setPlaceholder()">
            <label for="y/d/m">YY[YY]/DD/MM</label>
            <br>

            <label for="date-input">Date:</label>
            <input type="text" id="date-input" name="date" pattern="-?\d+\.?\d*/-?\d+\.?\d*/-?\d+\.?\d*" placeholder="DD/MM/YY[YY]">
            <input type="submit">
        </form>
        <p>your real date (YYYY-MM-DD): <a id="real-date"></a></p>
        <script>
            document.getElementById('input-form').addEventListener('submit', parseDate)
        </script>
    </body>
    
</html>
